üß† CONTEXTO GENERAL: ¬øQu√© es el controlador?

En MVC:

Modelo ‚Üí trabaja con datos (archivo txt)

Vista ‚Üí muestra HTML

Controlador ‚Üí decide qu√© hacer

El controlador es como el jefe de tr√°fico:

"¬øQu√© quiere el usuario? ¬øListar? ¬øCrear? ¬øGuardar? Vale, llamo al modelo y luego cargo la vista correcta."

1Ô∏è‚É£ Constructor
function __construct() {
    $this->repositorio = new RepositorioNotas();
}

¬øQu√© hace?

Cuando haces:

$controlador = new ControladorNotas();


PHP ejecuta autom√°ticamente el constructor.

Entonces aqu√≠ estamos diciendo:

‚ÄúCada vez que se cree un controlador, crea tambi√©n un repositorio.‚Äù

¬øPor qu√©?

Porque el controlador necesita hablar con el modelo:

$this->repositorio->obtenerTodas();
$this->repositorio->agregar($nota);


Si no lo creas en el constructor, no existir√≠a.

2Ô∏è‚É£ renderizar($vista, $datos)

Este es el m√°s importante mentalmente.

private function renderizar($vista, $datos = []) {
    extract($datos);
    $archivoVista = __DIR__ . '/../Vistas/' . $vista . '.php';
    $vistaContenido = $archivoVista;
    require __DIR__ . '/../Vistas/layout.php';
}


Vamos l√≠nea por l√≠nea:

üîπ extract($datos);

Imagina que llamas:

$this->renderizar('notas/listar', [
    'notas' => $notas
]);


Entonces $datos vale:

[
   'notas' => $notas
]


Cuando haces:

extract($datos);


PHP crea autom√°ticamente variables:

$notas = $notas;


Es como convertir el array en variables sueltas.

Eso permite que en la vista puedas usar:

foreach ($notas as $n)


Si no us√°ramos extract, la vista no tendr√≠a acceso a $notas.

üîπ $archivoVista = ...
$archivoVista = __DIR__ . '/../Vistas/' . $vista . '.php';


Si $vista es:

notas/listar


Se convierte en:

.../app/Vistas/notas/listar.php


Estamos construyendo la ruta real al archivo.

üîπ $vistaContenido = $archivoVista;

Esto es clave.

Le estamos pasando la ruta al layout.

üîπ require layout.php

Aqu√≠ es donde ocurre la magia.

En layout.php tienes algo como:

<?php require $vistaContenido; ?>


O sea:

Carga el layout (estructura general HTML)

Dentro del layout carga la vista concreta

Es como decir:

‚ÄúCarga la plantilla general y mete dentro el contenido espec√≠fico.‚Äù

3Ô∏è‚É£ listar()
public function listar() {
    try {
        $notas = $this->repositorio->obtenerTodas();
        $this->renderizar('notas/listar', ['notas' => $notas]);
    } catch (Exception $e) {
        $this->registrarError('LISTAR', $e);
        $this->renderizar('notas/listar', [
            'notas' => [],
            'error' => 'No se pudieron cargar las notas'
        ]);
    }
}

¬øQu√© est√° pasando realmente?

Cuando el usuario entra en:

index.php?accion=listar


index.php llama a:

$controlador->listar();


Dentro:

Paso 1

Le pide al modelo:

$notas = $this->repositorio->obtenerTodas();


Eso lee el archivo notas.txt.

Paso 2

Le pasa esas notas a la vista.

¬øPor qu√© try/catch?

Porque si:

el archivo no existe

est√° corrupto

no se puede leer

Se lanza una excepci√≥n.

En ese caso:

registramos error

mostramos la vista pero con notas vac√≠as

mostramos mensaje de error

Es programaci√≥n defensiva.

4Ô∏è‚É£ crear()
public function crear() {
    $this->renderizar('notas/crear', [
        'antiguos' => ['texto' => '']
    ]);
}


Esto solo muestra el formulario.

¬øPor qu√© mandamos 'antiguos'?

Porque en el formulario tenemos:

<textarea>
<?php echo htmlspecialchars($antiguos['texto'] ?? ''); ?>
</textarea>


Si no enviamos eso, la variable no existir√≠a.

5Ô∏è‚É£ guardar()

Este es el cerebro.

$texto = trim($_POST['texto'] ?? '');

¬øQu√© hace?

Coge el texto enviado por el formulario

Si no existe ‚Üí usa ''

trim() elimina espacios al inicio y final

Validaci√≥n
if (strlen($texto) < 3)


¬øPor qu√© aqu√≠?

Porque el controlador decide si los datos son v√°lidos.

El modelo solo guarda.

Si falla ‚Üí lanzamos Exception.

Lanzar excepci√≥n significa:

"Algo no est√° bien, interrumpe el flujo normal."

Crear la nota
$id = time();
$fecha = date('Y-m-d H:i:s');
$nota = new Nota($id, $texto, $fecha);


Estamos creando un objeto.

No guardamos directamente texto.

Creamos una entidad Nota.

Guardar
$this->repositorio->agregar($nota);


El controlador no sabe c√≥mo se guarda.

Solo dice:

‚ÄúOye repositorio, guarda esto.‚Äù

Separaci√≥n de responsabilidades.

Redirecci√≥n
header("Location: index.php?accion=listar");
exit;


Esto es important√≠simo.

Despu√©s de guardar, no queremos que el usuario recargue el POST.

Redirigimos a listar.

Es patr√≥n PRG (Post-Redirect-Get).

Si hay error
catch (Exception $e)


Si algo falla:

validaci√≥n

escritura en archivo

etc

Hacemos:

registrar error

volver al formulario

mostrar el mensaje

mantener el texto escrito

6Ô∏è‚É£ registrarError()
$archivoLog = __DIR__ . '/../../storage/errores.log';


Subimos dos carpetas desde:

app/Controladores


Hasta:

storage/

file_put_contents(..., FILE_APPEND);


FILE_APPEND significa:

A√±ade al final, no sobrescribas.

üéØ RESUMEN MENTAL

Cuando alguien usa tu web:

index.php decide acci√≥n

llama al m√©todo del controlador

el controlador:

habla con modelo

decide vista

renderizar carga layout + vista

El controlador es el director de orquesta.